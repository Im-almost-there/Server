name: Trello Integration

on:
  push:
    # branches: [ main, develop ]
  pull_request:
    types: [opened, closed]

jobs:
  # 2. Ïª§Î∞ãÏóê Ïù¥Ïäà Î≤àÌò∏Í∞Ä ÏûàÏúºÎ©¥ Trello Ïπ¥ÎìúÏóê Ïª§Î∞ã Ï†ïÎ≥¥ Ï∂îÍ∞Ä
  commit-to-trello:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Extract issue numbers and update Trello
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Ïª§Î∞ã Î©îÏãúÏßÄÏóêÏÑú #Ïù¥ÏäàÎ≤àÌò∏ Ï∂îÏ∂ú (Ï†ÑÏ≤¥ Ïª§Î∞ã Î©îÏãúÏßÄ, Ïó¨Îü¨ Ï§Ñ ÏßÄÏõê)
        COMMIT_MSG=$(git log -1 --pretty=format:"%B")
        echo "Full commit message: $COMMIT_MSG"
        
        # #Ïà´Ïûê Ìå®ÌÑ¥ Ï∞æÍ∏∞ (Ïó¨Îü¨ Ï§ÑÏóêÏÑú)
        ISSUE_NUMBERS=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sed 's/#//')
        
        for ISSUE_NUM in $ISSUE_NUMBERS; do
          echo "Processing issue #$ISSUE_NUM"
          
          # GitHub APIÎ°ú Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
          ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
          
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
          
          # Ïù¥Ïäà Î≥∏Î¨∏ÏóêÏÑú Trello Ïπ¥Îìú ID Ï∞æÍ∏∞ (Ïó¨Îü¨ Ìå®ÌÑ¥ ÏßÄÏõê)
          TRELLO_CARD_ID=""
          
          # Ìå®ÌÑ¥ 1: Trello-Card-ID: 12345678
          TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:\s*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:\s*//')
          
          # Ìå®ÌÑ¥ 2: https://trello.com/c/abcd1234/
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
          fi
          
          # Ìå®ÌÑ¥ 3: ÌÖúÌîåÎ¶øÏùò üìã Trello Ïπ¥Îìú Ïó∞Í≤∞ ÌïÑÎìúÏóêÏÑú 8ÏûêÎ¶¨ ÎòêÎäî 24ÏûêÎ¶¨ ID Ï∞æÍ∏∞
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A5 "üìã Trello Ïπ¥Îìú Ïó∞Í≤∞" | grep -oE "\b[a-zA-Z0-9]{8,24}\b" | head -1)
          fi
          
          # Ìå®ÌÑ¥ 4: Îã®ÏàúÌûà 8ÏûêÎ¶¨ shortLink ÎòêÎäî 24ÏûêÎ¶¨ IDÎßå ÏûàÎäî Í≤ΩÏö∞
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "\b[a-zA-Z0-9]{8}\b|\b[a-zA-Z0-9]{24}\b" | head -1)
          fi
          
          echo "Debug - Issue body excerpt:"
          echo "$ISSUE_BODY" | head -10
          
          if [ -n "$TRELLO_CARD_ID" ]; then
            echo "Found Trello Card ID: $TRELLO_CARD_ID"
            
            # Trello Ïπ¥ÎìúÏóê Ïª§Î∞ã Ï†ïÎ≥¥ ÎåìÍ∏Ä Ï∂îÍ∞Ä
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
            COMMIT_SHORT_SHA="${{ github.sha }}"
            COMMIT_SHORT_SHA="${COMMIT_SHORT_SHA:0:7}"
            
            COMMENT_TEXT="Ïª§Î∞ã: $COMMIT_URL"
            
            echo "Calling Trello API with card ID: $TRELLO_CARD_ID"
            echo "API URL: https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=***&token=***"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
              -d "{\"text\":\"$COMMENT_TEXT\"}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            echo "HTTP Response Code: $HTTP_CODE"
            echo "Response Body: $RESPONSE_BODY"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Successfully added commit info to Trello card $TRELLO_CARD_ID"
            else
              echo "‚ùå Failed to add comment to Trello card"
              echo "Error details: $RESPONSE_BODY"
            fi
          else
            echo "No Trello Card ID found in issue #$ISSUE_NUM"
          fi
        done

  # 3. PR ÏÉùÏÑ±Ïãú Code Review Î¶¨Ïä§Ìä∏Î°ú Ïù¥Îèô
  pr-to-review:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
    - name: Move Trello card to Code Review
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
        TRELLO_CODE_REVIEW_LIST_ID: ${{ secrets.TRELLO_CODE_REVIEW_LIST_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        
        echo "PR Body: $PR_BODY"
        
        # PR Î≥∏Î¨∏ÏóêÏÑú Ïù¥Ïäà Î≤àÌò∏ Ï∂îÏ∂ú (closes #123, fixes #456 Îì±)
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "#[0-9]+" | sed 's/#//')
        
        # PR Ï†úÎ™©ÏóêÏÑúÎèÑ Ïù¥Ïäà Î≤àÌò∏ Ï∞æÍ∏∞
        TITLE_ISSUES=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | sed 's/#//')
        
        ALL_ISSUES="$ISSUE_NUMBERS $TITLE_ISSUES"
        
        for ISSUE_NUM in $ALL_ISSUES; do
          if [ -n "$ISSUE_NUM" ]; then
            echo "Processing issue #$ISSUE_NUM for PR"
            
            # Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
            
            ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
            
            # Trello Ïπ¥Îìú ID Ï∞æÍ∏∞ (Ïó¨Îü¨ Ìå®ÌÑ¥ ÏßÄÏõê)
            TRELLO_CARD_ID=""
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:\\s*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:\\s*//')
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\\.com\\/c\\///' | cut -d'/' -f1)
            fi
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A2 "üìã Trello Ïπ¥Îìú" | grep -oE "([a-zA-Z0-9]{24}|trello\\.com/c/[a-zA-Z0-9]+)" | sed 's/.*trello\\.com\\/c\\///' | cut -d'/' -f1)
            fi
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "\\b[a-zA-Z0-9]{24}\\b" | head -1)
            fi

            # Ïπ¥Îìú ID Ï∂îÏ∂ú Í≤∞Í≥º Ï∂úÎ†• Ï∂îÍ∞Ä
            echo "Found Trello Card ID: $TRELLO_CARD_ID"

            if [ -n "$TRELLO_CARD_ID" ]; then
              echo "Moving Trello card $TRELLO_CARD_ID to Code Review"
              
              # Ïπ¥Îìú Ïù¥Îèô API Ìò∏Ï∂ú Î∞è ÏùëÎãµ Ï†ÄÏû•
              RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN&idList=$TRELLO_CODE_REVIEW_LIST_ID")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

              # API Ìò∏Ï∂ú Í≤∞Í≥º Ï∂úÎ†• Ï∂îÍ∞Ä
              echo "Move card response code: $HTTP_CODE"
              echo "Move card response body: $RESPONSE_BODY"

              # PR Ï†ïÎ≥¥ Ïπ¥ÎìúÏóê ÎåìÍ∏ÄÎ°ú Ï∂îÍ∞Ä
              COMMENT_TEXT="PR: $PR_URL"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
                -d "{\"text\":\"$COMMENT_TEXT\"}"

              echo "Moved card to Code Review and added PR info"
            else
              echo "No Trello Card ID found in issue #$ISSUE_NUM"
            fi
          fi
        done


  # 4. PR Î®∏ÏßÄÏãú Done Î¶¨Ïä§Ìä∏Î°ú Ïù¥Îèô
  pr-to-done:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Move Trello card to Done
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        TRELLO_DONE_LIST_ID: ${{ secrets.TRELLO_DONE_LIST_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        
        # PRÏóêÏÑú Ïù¥Ïäà Î≤àÌò∏ Ï∂îÏ∂ú
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "#[0-9]+" | sed 's/#//')
        TITLE_ISSUES=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | sed 's/#//')
        
        ALL_ISSUES="$ISSUE_NUMBERS $TITLE_ISSUES"
        
        for ISSUE_NUM in $ALL_ISSUES; do
          if [ -n "$ISSUE_NUM" ]; then
            echo "Processing issue #$ISSUE_NUM for merged PR"
            
            # Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            echo "Fetching issue #$ISSUE_NUM from GitHub API..."
            ISSUE_DATA=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")

            HTTP_CODE=$(echo "$ISSUE_DATA" | tail -n1)
            RESPONSE_BODY=$(echo "$ISSUE_DATA" | head -n -1)

            echo "GitHub API Response Code: $HTTP_CODE"
            echo "Response preview: $(echo "$RESPONSE_BODY" | head -c 200)..."

            if [ "$HTTP_CODE" != "200" ]; then
              echo "‚ùå Failed to fetch issue #$ISSUE_NUM from GitHub API"
              continue
            fi

            ISSUE_BODY=$(echo "$RESPONSE_BODY" | jq -r '.body // ""')
            echo "Issue body preview: $(echo "$ISSUE_BODY" | head -c 100)..."
            
            # Trello Ïπ¥Îìú ID Ï∞æÍ∏∞ (Ïó¨Îü¨ Ìå®ÌÑ¥ ÏßÄÏõê)
            TRELLO_CARD_ID=""
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:\s*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:\s*//')
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            # ÌÖúÌîåÎ¶ø ÌòïÏãùÏóêÏÑú Ï∂îÏ∂ú
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A2 "üìã Trello Ïπ¥Îìú" | grep -oE "([a-zA-Z0-9]{24}|trello\.com/c/[a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            # Îã®Ïàú ID Ìå®ÌÑ¥
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "\b[a-zA-Z0-9]{24}\b" | head -1)
            fi
            
            if [ -n "$TRELLO_CARD_ID" ]; then
              echo "Moving Trello card $TRELLO_CARD_ID to Done"
              
              # Ïπ¥ÎìúÎ•º Done Î¶¨Ïä§Ìä∏Î°ú Ïù¥Îèô
              curl -X PUT \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN&idList=$TRELLO_DONE_LIST_ID"
              
              # ÏôÑÎ£å Ï†ïÎ≥¥Î•º Ïπ¥ÎìúÏóê ÎåìÍ∏ÄÎ°ú Ï∂îÍ∞Ä
              COMMENT_TEXT="Î®∏ÏßÄ: $PR_URL"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
                -d "{\"text\":\"$COMMENT_TEXT\"}"
              
              echo "Moved card to Done and added completion info"
            fi
          fi
        done