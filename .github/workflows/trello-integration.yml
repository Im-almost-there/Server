name: Trello Integration

on:
  push:
    # branches: [ main, develop ]
  pull_request:
    types: [opened, closed]

jobs:
  # ì»¤ë°‹ì— ì´ìŠˆ ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ Trello ì¹´ë“œì— ì»¤ë°‹ ì •ë³´ ì¶”ê°€
  commit-to-trello:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Extract issue numbers and update Trello
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ #ì´ìŠˆë²ˆí˜¸ ì¶”ì¶œ
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        echo "Commit message: $COMMIT_MSG"
        
        # #ìˆ«ì íŒ¨í„´ ì°¾ê¸°
        ISSUE_NUMBERS=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sed 's/#//')
        
        for ISSUE_NUM in $ISSUE_NUMBERS; do
          echo "Processing issue #$ISSUE_NUM"
          
          # GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
          
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
          
          # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ Trello ì¹´ë“œ ID ì°¾ê¸° (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
          TRELLO_CARD_ID=""
          
          # íŒ¨í„´ 1: Trello-Card-ID: 12345678
          TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:\s*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:\s*//')
          
          # íŒ¨í„´ 2: https://trello.com/c/abcd1234/
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
          fi
          
          # íŒ¨í„´ 3: í…œí”Œë¦¿ í˜•ì‹ (ğŸ“‹ Trello ì¹´ë“œ ì—°ê²° ì„¹ì…˜)
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A2 "ğŸ“‹ Trello ì¹´ë“œ" | grep -oE "([a-zA-Z0-9]{24}|trello\.com/c/[a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
          fi
          
          # íŒ¨í„´ 4: ë‹¨ìˆœíˆ 24ìë¦¬ Trello IDë§Œ ìˆëŠ” ê²½ìš°
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "\b[a-zA-Z0-9]{24}\b" | head -1)
          fi
          
          if [ -n "$TRELLO_CARD_ID" ]; then
            echo "Found Trello Card ID: $TRELLO_CARD_ID"
            
            # Trello ì¹´ë“œì— ì»¤ë°‹ ì •ë³´ ëŒ“ê¸€ ì¶”ê°€
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
            COMMIT_SHORT_SHA="${{ github.sha }}"
            COMMIT_SHORT_SHA="${COMMIT_SHORT_SHA:0:7}"
            
            COMMENT_TEXT="**Commit ì¶”ê°€ë¨**
            
            **ì»¤ë°‹**: [\`$COMMIT_SHORT_SHA\`]($COMMIT_URL)
            **ë©”ì‹œì§€**: $COMMIT_MSG
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            **ì‘ì„±ì**: ${{ github.actor }}"
            
            curl -X POST \
              -H "Content-Type: application/json" \
              "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
              -d "{\"text\":\"$COMMENT_TEXT\"}"
              
            echo "Added commit info to Trello card $TRELLO_CARD_ID"
          else
            echo "No Trello Card ID found in issue #$ISSUE_NUM"
          fi
        done

  # PR ìƒì„±ì‹œ Code Review ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
  pr-to-review:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
    - name: Move Trello card to Code Review
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
        TRELLO_CODE_REVIEW_LIST_ID: ${{ secrets.TRELLO_CODE_REVIEW_LIST_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        
        echo "PR Body: $PR_BODY"
        
        # PR ë³¸ë¬¸ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (closes #123, fixes #456 ë“±)
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "#[0-9]+" | sed 's/#//')
        
        # PR ì œëª©ì—ì„œë„ ì´ìŠˆ ë²ˆí˜¸ ì°¾ê¸°
        TITLE_ISSUES=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | sed 's/#//')
        
        ALL_ISSUES="$ISSUE_NUMBERS $TITLE_ISSUES"
        
        for ISSUE_NUM in $ALL_ISSUES; do
          if [ -n "$ISSUE_NUM" ]; then
            echo "Processing issue #$ISSUE_NUM for PR"
            
            # ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
            
            ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
            
            # Trello ì¹´ë“œ ID ì°¾ê¸° (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
            TRELLO_CARD_ID=""
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:\s*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:\s*//')
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            # í…œí”Œë¦¿ í˜•ì‹ì—ì„œ ì¶”ì¶œ
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A2 "ğŸ“‹ Trello ì¹´ë“œ" | grep -oE "([a-zA-Z0-9]{24}|trello\.com/c/[a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            # ë‹¨ìˆœ ID íŒ¨í„´
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "\b[a-zA-Z0-9]{24}\b" | head -1)
            fi
            
            if [ -n "$TRELLO_CARD_ID" ]; then
              echo "Moving Trello card $TRELLO_CARD_ID to Code Review"
              
              # ì¹´ë“œë¥¼ Code Review ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
              curl -X PUT \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN&idList=$TRELLO_CODE_REVIEW_LIST_ID"
              
              # PR ì •ë³´ë¥¼ ì¹´ë“œì— ëŒ“ê¸€ë¡œ ì¶”ê°€
              COMMENT_TEXT="**Pull Request ìƒì„±ë¨**
              
              **PR**: [$PR_TITLE]($PR_URL)
              **ì‘ì„±ì**: ${{ github.actor }}
              **ë¸Œëœì¹˜**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
                -d "{\"text\":\"$COMMENT_TEXT\"}"
              
              echo "Moved card to Code Review and added PR info"
            fi
          fi
        done

  # PR ë¨¸ì§€ì‹œ Done ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
  pr-to-done:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Move Trello card to Done
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        TRELLO_DONE_LIST_ID: ${{ secrets.TRELLO_DONE_LIST_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        
        # PRì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "#[0-9]+" | sed 's/#//')
        TITLE_ISSUES=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | sed 's/#//')
        
        ALL_ISSUES="$ISSUE_NUMBERS $TITLE_ISSUES"
        
        for ISSUE_NUM in $ALL_ISSUES; do
          if [ -n "$ISSUE_NUM" ]; then
            echo "Processing issue #$ISSUE_NUM for merged PR"
            
            # ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
            
            ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
            
            # Trello ì¹´ë“œ ID ì°¾ê¸° (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
            TRELLO_CARD_ID=""
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:\s*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:\s*//')
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            # í…œí”Œë¦¿ í˜•ì‹ì—ì„œ ì¶”ì¶œ
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A2 "ğŸ“‹ Trello ì¹´ë“œ" | grep -oE "([a-zA-Z0-9]{24}|trello\.com/c/[a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            # ë‹¨ìˆœ ID íŒ¨í„´
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "\b[a-zA-Z0-9]{24}\b" | head -1)
            fi
            
            if [ -n "$TRELLO_CARD_ID" ]; then
              echo "Moving Trello card $TRELLO_CARD_ID to Done"
              
              # ì¹´ë“œë¥¼ Done ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
              curl -X PUT \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN&idList=$TRELLO_DONE_LIST_ID"
              
              # ì™„ë£Œ ì •ë³´ë¥¼ ì¹´ë“œì— ëŒ“ê¸€ë¡œ ì¶”ê°€
              COMMENT_TEXT="âœ… **Pull Request ë¨¸ì§€ ì™„ë£Œ**
              
              **PR**: [$PR_TITLE]($PR_URL)
              **ë¨¸ì§€ì**: ${{ github.actor }}
              **ì™„ë£Œ ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
                -d "{\"text\":\"$COMMENT_TEXT\"}"
              
              echo "Moved card to Done and added completion info"
            fi
          fi
        done