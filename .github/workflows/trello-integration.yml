name: Trello Integration

on:
  push:
    # branches: [ main, develop ]
  pull_request:
    types: [opened, closed]

jobs:
  # 2. Ïª§Î∞ãÏóê Ïù¥Ïäà Î≤àÌò∏Í∞Ä ÏûàÏúºÎ©¥ Trello Ïπ¥ÎìúÏóê Ïª§Î∞ã Ï†ïÎ≥¥ Ï∂îÍ∞Ä
  commit-to-trello:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Extract issue numbers and update Trello
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%B")
        echo "Full commit message: $COMMIT_MSG"
        
        ISSUE_NUMBERS=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sed 's/#//')

        for ISSUE_NUM in $ISSUE_NUMBERS; do
          echo "Processing issue #$ISSUE_NUM"
          ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
          
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')

          TRELLO_CARD_ID=""
          TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:[[:space:]]*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:[[:space:]]*//')
          
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
          fi
          
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A5 "üìã Trello Ïπ¥Îìú Ïó∞Í≤∞" | grep -oE "[a-zA-Z0-9]{8,24}" | head -1)
          fi
          
          if [ -z "$TRELLO_CARD_ID" ]; then
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "[a-zA-Z0-9]{8}|[a-zA-Z0-9]{24}" | head -1)
          fi

          echo "Debug - Issue body excerpt:"
          echo "$ISSUE_BODY" | head -10

          if [ -n "$TRELLO_CARD_ID" ]; then
            echo "Found Trello Card ID: $TRELLO_CARD_ID"
            
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

            COMMENT_TEXT="Ïª§Î∞ã: $COMMIT_URL"

            echo "Calling Trello API with card ID: $TRELLO_CARD_ID"

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
              -d "{\"text\":\"$COMMENT_TEXT\"}")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

            echo "HTTP Response Code: $HTTP_CODE"
            echo "Response Body: $RESPONSE_BODY"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Successfully added commit info to Trello card $TRELLO_CARD_ID"
            else
              echo "‚ùå Failed to add comment to Trello card"
              echo "Error details: $RESPONSE_BODY"
            fi
          else
            echo "No Trello Card ID found in issue #$ISSUE_NUM"
          fi
        done

  # 3. PR ÏÉùÏÑ±Ïãú Code Review Î¶¨Ïä§Ìä∏Î°ú Ïù¥Îèô
  pr-to-review:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
    - name: Move Trello card to Code Review
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
        TRELLO_CODE_REVIEW_LIST_ID: ${{ secrets.TRELLO_CODE_REVIEW_LIST_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        
        echo "PR Body: $PR_BODY"
        
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "#[0-9]+" | sed 's/#//')
        
        TITLE_ISSUES=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | sed 's/#//')
        
        ALL_ISSUES="$ISSUE_NUMBERS $TITLE_ISSUES"
        
        for ISSUE_NUM in $ALL_ISSUES; do
          if [ -n "$ISSUE_NUM" ]; then
            echo "Processing issue #$ISSUE_NUM for PR"
            
            ISSUE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")
            
            ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')

            TRELLO_CARD_ID=""
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:[[:space:]]*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:[[:space:]]*//')
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A5 "üìã Trello Ïπ¥Îìú Ïó∞Í≤∞" | grep -oE "[a-zA-Z0-9]{8,24}" | head -1)
            fi
            
            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "[a-zA-Z0-9]{8}|[a-zA-Z0-9]{24}" | head -1)
            fi

            echo "Found Trello Card ID: $TRELLO_CARD_ID"
              
            if [ -n "$TRELLO_CARD_ID" ]; then
              echo "Moving Trello card $TRELLO_CARD_ID to Code Review"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN&idList=$TRELLO_CODE_REVIEW_LIST_ID")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

              echo "Move card response code: $HTTP_CODE"
              echo "Move card response body: $RESPONSE_BODY"
              
              COMMENT_TEXT="PR: $PR_URL"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
                -d "{\"text\":\"$COMMENT_TEXT\"}"

              echo "Moved card to Code Review and added PR info"
            else
              echo "No Trello Card ID found in issue #$ISSUE_NUM"
            fi
          fi
        done

  # 4. PR Î®∏ÏßÄÏãú Done Î¶¨Ïä§Ìä∏Î°ú Ïù¥Îèô
  pr-to-done:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Move Trello card to Done
      env:
        TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        TRELLO_DONE_LIST_ID: ${{ secrets.TRELLO_DONE_LIST_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        
        ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiE "(closes?|fixes?|resolves?) #([0-9]+)" | grep -oE "#[0-9]+" | sed 's/#//')
        TITLE_ISSUES=$(echo "$PR_TITLE" | grep -oE '#[0-9]+' | sed 's/#//')
        
        ALL_ISSUES="$ISSUE_NUMBERS $TITLE_ISSUES"
        
        for ISSUE_NUM in $ALL_ISSUES; do
          if [ -n "$ISSUE_NUM" ]; then
            echo "Processing issue #$ISSUE_NUM for merged PR"
            ISSUE_DATA=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUM")

            HTTP_CODE=$(echo "$ISSUE_DATA" | tail -n1)
            RESPONSE_BODY=$(echo "$ISSUE_DATA" | head -n -1)

            echo "GitHub API Response Code: $HTTP_CODE"
            echo "Response preview: $(echo "$RESPONSE_BODY" | head -c 200)..."

            if [ "$HTTP_CODE" != "200" ]; then
              echo "‚ùå Failed to fetch issue #$ISSUE_NUM from GitHub API"
              continue
            fi

            ISSUE_BODY=$(echo "$RESPONSE_BODY" | jq -r '.body // ""')
            echo "Issue body preview: $(echo "$ISSUE_BODY" | head -c 100)..."

            TRELLO_CARD_ID=""
            TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "Trello-Card-ID:[[:space:]]*([a-zA-Z0-9]+)" | sed 's/Trello-Card-ID:[[:space:]]*//')

            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "trello\.com/c/([a-zA-Z0-9]+)" | sed 's/.*trello\.com\/c\///' | cut -d'/' -f1)
            fi

            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -A2 "üìã Trello Ïπ¥Îìú" | grep -oE "[a-zA-Z0-9]{8,24}" | head -1)
            fi

            if [ -z "$TRELLO_CARD_ID" ]; then
              TRELLO_CARD_ID=$(echo "$ISSUE_BODY" | grep -oE "[a-zA-Z0-9]{24}" | head -1)
            fi

            if [ -n "$TRELLO_CARD_ID" ]; then
              echo "Moving Trello card $TRELLO_CARD_ID to Done"
              
              curl -X PUT \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN&idList=$TRELLO_DONE_LIST_ID"

              COMMENT_TEXT="Î®∏ÏßÄ: $PR_URL"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                "https://api.trello.com/1/cards/$TRELLO_CARD_ID/actions/comments?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
                -d "{\"text\":\"$COMMENT_TEXT\"}"

              echo "Moved card to Done and added completion info"
            fi
          fi
        done
